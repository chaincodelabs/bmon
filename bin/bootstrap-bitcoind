#!/usr/bin/env python3

import getpass

import fscm
from fscm.remote import mitogen_context
from fscm.contrib import python
import clii

cli = clii.App()


def bootstrap(regular_user: str):
    assert (fscm.s.is_debian() or fscm.s.is_ubuntu())

    python.install_python3()
    fscm.s.pkgs_install(
        "sudo vim git docker.io curl tcpdump nmap ntp ripgrep libpq5 wireguard-tools"
    )
    fscm.s.group_member(regular_user, "docker")
    p(docker := Path.home() / ".docker").mkdir()
    p(docker / "config.json").contents('{ "detachKeys": "ctrl-z,z" }')


@cli.main
def main(host: str, sudo_pass: str, regular_user: str):
    host = host
    username = getpass.getuser()
    if "@" in host:
        username, host = host.split("@")

    with mitogen_context(hostname=host, username=username) as (router, context):
        s = router.sudo(via=context, password=sudo_pass)
        s.call(bootstrap, regular_user)


if __name__ == "__main__":
    cli.run()
