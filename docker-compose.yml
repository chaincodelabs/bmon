# Services that run on the single, centralized bmon server instance.
#
# Environment is injected from the .env file, which is generated by
# `./infra/bmon_infra/config.py`.

version: '3.5'

services:

  db:
    profiles: ["server"]
    image: docker.io/library/postgres:11
    environment:
      - POSTGRES_DB=bmon
      - POSTGRES_USER=bmon
      - POSTGRES_PASSWORD=${BMON_DATABASE_PASSWORD}
    volumes:
      - 'db-data:/var/lib/postgresql/data'
    ports:
      - 5432:5432

  redis:
    profiles: ["server"]
    image: docker.io/library/redis
    ports:
      - 6379:6379

  grafana:
    profiles: ["server"]
    image: docker.io/grafana/grafana-enterprise
    user: "${UID}"
    volumes:
      - ${ENV_ROOT}/grafana/etc:/etc/grafana
      - ${ENV_ROOT}/grafana/var:/var/lib/grafana
    links:
      - prom
      - alertman
      - loki
    ports:
      - 3000:3000

  loki:
    profiles: ["server"]
    image: docker.io/grafana/loki
    user: "${UID}"
    volumes:
      - ${ENV_ROOT}/loki:/loki
      - ${ENV_ROOT}/loki/etc:/etc/loki
    links:
      - alertman
    command: -config.file=/etc/loki/local-config.yaml
    ports:
      - 3100:3100

  prom:
    profiles: ["server"]
    image: docker.io/prom/prometheus
    user: "${UID}"
    volumes:
      - ${ENV_ROOT}/prom/etc:/etc/prometheus
      - ${ENV_ROOT}/prom/data:/prometheus
    links:
      - alertman
    ports:
      - 9090:9090

  alertman:
    profiles: ["server"]
    image: docker.io/prom/alertmanager
    user: "${UID}:1000"
    volumes:
      - ${ENV_ROOT}/alertman/config.yml:/etc/alertmanager/config.yml
      - ${ENV_ROOT}/alertman/data:/alertmanager
    command: --config.file=/etc/alertmanager/config.yml --storage.path=/alertmanager
    ports:
      - 9093

  web:
    profiles: ["server"]
    image: web
    user: "${UID}"
    build:
      context: .
      dockerfile: ./docker/py.Dockerfile
    image: bmon-base-image
    environment:
      - BMON_DATABASE_URL
    ports:
      - 8080:8080
    volumes:
      - ./:/src
    links:
      - db
    command: bmon-server

  aggregator-celery-worker:
    profiles: ["server"]
    image: bmon-base-image
    environment:
      - BMON_DATABASE_URL
      - BMON_REDIS_CENTRAL_URL=redis://redis:6379/0
    volumes:
      - ./:/src
      - /home/james/.bitcoind/debug.log:/var/log/bitcoind.log
    links:
      - db
      - redis
    command: celery -A bmon.aggregator_worker.tasks:app worker

  bitcoind-exporter:
    profiles: ["bitcoind"]
    image: jvstein/bitcoin-prometheus-exporter:latest
    environment:
      - PYTHONUNBUFFERED=1
      - BITCOIN_RPC_HOST
      - BITCOIN_RPC_PORT
      - BITCOIN_RPC_USER
      - BITCOIN_RPC_PASSWORD
    links:
      - bitcoind
    ports:
      - 9332:9332

  bitcoind:
    profiles: ["bitcoind"]
    image: jamesob/bitcoind:${BITCOIN_DOCKER_TAG}
    user: "${UID}"
    volumes:
      - ${ENV_ROOT}/bitcoin/data:/bitcoin/data
    command: bitcoind -datadir=/bitcoin/data ${BITCOIN_NETWORK_FLAG} -debug ${BITCOIN_EXTRA_ARGS}

  promtail:
    profiles: ["bitcoind"]
    image: docker.io/grafana/promtail
    user: "${UID}"
    environment:
      - BMON_DATABASE_URL
      - BMON_REDIS_LOCAL_URL
      - BMON_REDIS_CENTRAL_URL
      - WAIT_FOR=${LOKI_HOST}:${LOKI_PORT}
    volumes:
      - ${ENV_ROOT}/promtail:/etc/promtail
      - ${BITCOIN_DATA_PATH}:/bitcoin/data
    command: --config.file=/etc/promtail/config.yml
    links:
      - bitcoind

  redis-bitcoind:
    profiles: ["prod-bitcoind"]
    image: docker.io/library/redis
    ports:
      - 6379:6379

  bitcoind-celery-worker:
    profiles: ["bitcoind"]
    build:
      context: .
      dockerfile: ./docker/py.Dockerfile
    image: bmon-base-image
    environment:
      - BMON_DATABASE_URL
      - BMON_REDIS_LOCAL_URL
      - BMON_REDIS_CENTRAL_URL
      - WAIT_FOR=${BMON_DATABASE_HOST}:${BMON_DATABASE_PORT},${BMON_REDIS_HOST}:6379,${BMON_REDIS_LOCAL_HOST}:6379
    volumes:
      - ./:/src
    links:
      - redis-bitcoind
    command: celery -A bmon.bitcoind_worker.tasks:app worker

  bitcoind-watcher:
    profiles: ["bitcoind"]
    image: bmon-base-image
    environment:
      - BMON_DATABASE_URL
      - BMON_REDIS_LOCAL_URL
      - BMON_REDIS_CENTRAL_URL
      - BMON_BITCOIND_LOG_PATH=/var/log/bitcoind.log
      - WAIT_FOR=${BMON_DATABASE_HOST}:${BMON_DATABASE_PORT},${BMON_REDIS_HOST}:6379
    volumes:
      - ./:/src
      - ${BITCOIN_DATA_PATH}/debug.log:/var/log/bitcoind.log
    links:
      - bitcoind-celery-worker
    command: bmon-watch-bitcoind

  node-exporter:
    # only monitor this stuff in prod since its mountpoint needs are zealous.
    profiles: ["prod"]  
    image: prom/node-exporter:latest
    restart: unless-stopped
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    ports:
      - 9100:9100

volumes:
  db-data:
